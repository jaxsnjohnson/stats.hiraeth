<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>D&D 5e Stat Block Generator</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <style>
      :root {
        --bg: #f8f6f1;
        --panel: #ffffff;
        --ink: #1a1a1a;
        --accent: #b89a67;
        --rule: #d8ccb2;
        --muted: #555;
        --red: #9c2b2e;
        --link: #2b6cb0;
        --radius: 8px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .dark-mode {
        --bg: #1a1a1a;
        --panel: #2d2d2d;
        --ink: #e8e6e3;
        --accent: #a88a57;
        --rule: #4a4a4a;
        --muted: #aaa;
        --red: #e57373;
        --link: #8ab4f8;
      }
      html,
      body {
        background: var(--bg);
        color: var(--ink);
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
        line-height: 1.4;
      }
      body {
        position: relative;
      }
      .wrap {
        max-width: 920px;
        margin: 20px auto 64px;
        padding: 0 16px;
        display: grid;
        gap: 16px;
      }
      #theme-toggle {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #theme-toggle:hover {
        background-color: rgba(0, 0, 0, 0.1);
      }
      #theme-toggle svg {
        width: 24px;
        height: 24px;
        fill: var(--ink);
      }
      .dark-mode .sun-icon {
        display: block;
      }
      .dark-mode .moon-icon {
        display: none;
      }
      .sun-icon {
        display: none;
      }
      .moon-icon {
        display: block;
      }
      .toolbar {
        background: var(--panel);
        border: 1px solid var(--rule);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 12px;
        display: grid;
        gap: 8px;
      }
      .toolbar-row {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 8px;
      }
      .section-header {
        grid-column: 1 / -1;
        font-weight: bold;
        color: var(--red);
        border-bottom: 1px solid var(--rule);
        padding-bottom: 4px;
        margin-top: 16px;
      }
      .toolbar .field {
        display: grid;
        gap: 4px;
      }
      .toolbar label {
        font-size: 12px;
        color: var(--muted);
      }
      .toolbar input[type="text"],
      .toolbar input[type="number"],
      .toolbar textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border: 1px solid var(--rule);
        border-radius: 6px;
        background: var(--bg);
        color: var(--ink);
        font-size: 14px;
      }
      .toolbar textarea {
        min-height: 64px;
        resize: vertical;
      }
      .toolbar .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--accent);
        background: var(--bg);
        color: var(--ink);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .dynamic-list {
        display: grid;
        gap: 8px;
        margin-top: 4px;
      }
      .dynamic-entry {
        display: grid;
        grid-template-columns: 1fr 2fr auto;
        gap: 8px;
        align-items: start;
      }
      .dynamic-entry textarea {
        min-height: 40px;
      }
      .statblock {
        background: var(--bg);
        border: 1px solid var(--rule);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .sb-header {
        background: #e6dccc;
        border-bottom: 1px solid var(--rule);
        padding: 14px 16px;
      }
      .dark-mode .sb-header {
        background: #3a3a3a;
      }
      .sb-name {
        font-family: Georgia, "Times New Roman", serif;
        font-size: 26px;
        font-weight: 800;
        color: var(--red);
        letter-spacing: 0.2px;
      }
      .sb-subtitle {
        color: var(--ink);
        margin-top: 4px;
        font-style: italic;
        font-size: 14px;
      }
      .sb-body {
        padding: 14px 16px 12px;
      }
      .hr {
        height: 2px;
        background: var(--accent);
        margin: 10px 0;
        opacity: 0.7;
      }
      .sb-row {
        margin: 6px 0;
      }
      .sb-label {
        font-variant: small-caps;
        font-weight: 700;
      }
      .abilities {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin: 10px 0;
      }
      .ability {
        background: var(--panel);
        border: 1px solid var(--rule);
        border-radius: 6px;
        text-align: center;
        padding: 8px 6px;
      }
      .ability .abbr {
        font-variant: small-caps;
        font-weight: 700;
      }
      .ability .score {
        font-size: 18px;
        font-weight: 700;
      }
      .ability .mod {
        color: var(--muted);
      }
      .section {
        margin: 12px 0;
      }
      .entry {
        margin: 6px 0;
      }
      .entry .name {
        font-weight: 700;
        font-style: italic;
      }
      .entry a,
      .dice-roll {
        color: var(--link);
        text-decoration: none;
        cursor: pointer;
        font-weight: bold;
      }
      .entry a:hover,
      .dice-roll:hover {
        text-decoration: underline;
      }
      .description {
        white-space: pre-wrap;
        background: var(--panel);
        border: 1px solid var(--rule);
        border-radius: 6px;
        padding: 10px;
        margin-top: 8px;
      }
      .footer-note {
        color: var(--muted);
        font-size: 12px;
        margin-top: 8px;
      }
      .small {
        font-size: 13px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: var(--panel);
        padding: 24px;
        border-radius: var(--radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 300px;
      }
      #modal-result {
        font-size: 24px;
        font-weight: bold;
        margin: 12px 0;
      }
      #modal-breakdown {
        font-size: 14px;
        color: var(--muted);
      }
      @keyframes dice-shake {
        0% {
          transform: translate(1px, 1px) rotate(0deg);
        }
        10% {
          transform: translate(-1px, -2px) rotate(-1deg);
        }
        20% {
          transform: translate(-3px, 0px) rotate(1deg);
        }
        30% {
          transform: translate(3px, 2px) rotate(0deg);
        }
        40% {
          transform: translate(1px, -1px) rotate(1deg);
        }
        50% {
          transform: translate(-1px, 2px) rotate(-1deg);
        }
        60% {
          transform: translate(-3px, 1px) rotate(0deg);
        }
        70% {
          transform: translate(3px, 1px) rotate(-1deg);
        }
        80% {
          transform: translate(-1px, -1px) rotate(1deg);
        }
        90% {
          transform: translate(1px, 2px) rotate(0deg);
        }
        100% {
          transform: translate(1px, -2px) rotate(-1deg);
        }
      }
      .rolling {
        animation: dice-shake 0.5s;
        animation-iteration-count: 1;
      }
      .col-2 {
        grid-column: span 2;
      }
      .col-3 {
        grid-column: span 3;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-6 {
        grid-column: span 6;
      }
      .col-8 {
        grid-column: span 8;
      }
      .col-12 {
        grid-column: span 12;
      }
      @media (max-width: 840px) {
        .toolbar-row {
          grid-template-columns: repeat(6, 1fr);
        }
        .col-8,
        .col-6,
        .col-4 {
          grid-column: span 6;
        }
        .col-3 {
          grid-column: span 3;
        }
      }
      @media (max-width: 520px) {
        .toolbar-row {
          grid-template-columns: repeat(4, 1fr);
        }
        .col-8,
        .col-6,
        .col-4,
        .col-3 {
          grid-column: span 4;
        }
        .dynamic-entry {
          grid-template-columns: 1fr;
        }
      }
      .embed-root {
        margin: 0;
        padding: 0;
        background: transparent;
      }
      .embed-root .wrap {
        margin: 0;
        padding: 0;
        max-width: none;
      }
      .embed-root .statblock {
        border: none;
        border-radius: 0;
        box-shadow: none;
      }
      .hidden {
        display: none !important;
      }
      @media print {
        body {
          background: #fff;
          color: #000;
        }
        .toolbar,
        .actions,
        #tips,
        .modal-overlay,
        #theme-toggle {
          display: none !important;
        }
        .wrap {
          margin: 0;
          padding: 0;
          max-width: 100%;
        }
        .statblock {
          border: 1px solid #000;
          box-shadow: none;
          border-radius: 0;
        }
        .sb-header {
          background: #ddd !important;
        }
        :root {
          --red: #000;
          --link: #000;
        }
        .entry a,
        .dice-roll {
          color: #000;
          text-decoration: none;
          font-weight: normal;
        }
      }
    </style>
  </head>
  <body>
    <button id="theme-toggle" title="Toggle theme">
      <svg
        class="sun-icon"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41zM5.64 18.36l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0L4.22 16.95c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0zm12.73-12.73l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0z"
        />
      </svg>
      <svg
        class="moon-icon"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-2.27-.98-4-3.15-4-5.69 0-3.41 2.79-6.2 6.2-6.2.39 0 .77.04 1.14.11-1.76-2.93-4.92-5-8.74-5z"
        />
      </svg>
    </button>
    <div class="wrap" id="root-wrap">
      <div class="toolbar" id="toolbar">
        <div class="toolbar-row">
          <div class="section-header">Basic Info</div>
          <div class="field col-6">
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="Ancient Red Dragon" />
          </div>
          <div class="field col-6">
            <label for="nickname">Nickname</label>
            <input id="nickname" type="text" />
          </div>
          <div class="field col-3">
            <label for="cr">Challenge Rating (CR)</label>
            <input id="cr" type="text" placeholder="24 (62,000 XP)" />
          </div>
          <div class="field col-3">
            <label for="lair_cr">Lair CR</label>
            <input id="lair_cr" type="text" />
          </div>
          <div class="field col-3">
            <label for="prof">Proficiency Bonus</label>
            <input id="prof" type="text" placeholder="+7" />
          </div>
          <div class="field col-3">
            <label for="size">Size</label>
            <input id="size" type="text" placeholder="Huge" />
          </div>
          <div class="field col-3">
            <label for="type">Type</label>
            <input id="type" type="text" placeholder="dragon" />
          </div>
          <div class="field col-3">
            <label for="alignment">Alignment</label>
            <input id="alignment" type="text" placeholder="chaotic evil" />
          </div>
        </div>
        <div class="toolbar-row">
          <div class="section-header">Combat Stats</div>
          <div class="field col-4">
            <label for="ac">Armor Class</label>
            <input id="ac" type="text" placeholder="22 (natural armor)" />
          </div>
          <div class="field col-4">
            <label for="hp">Hit Points</label>
            <input id="hp" type="text" placeholder="546 (28d20 + 252)" />
          </div>
          <div class="field col-4">
            <label for="hit_dice">Hit Dice</label>
            <input id="hit_dice" type="text" placeholder="28d20+252" />
          </div>
          <div class="field col-12">
            <label for="speed">Speed (comma-separated)</label>
            <input
              id="speed"
              type="text"
              placeholder="40 ft., fly 80 ft., swim 40 ft."
            />
          </div>
        </div>
        <div class="toolbar-row">
          <div class="section-header">Ability Scores</div>
          <div class="field col-2">
            <label for="str">STR</label>
            <input id="str" type="number" placeholder="30" />
          </div>
          <div class="field col-2">
            <label for="dex">DEX</label>
            <input id="dex" type="number" placeholder="10" />
          </div>
          <div class="field col-2">
            <label for="con">CON</label>
            <input id="con" type="number" placeholder="29" />
          </div>
          <div class="field col-2">
            <label for="int">INT</label>
            <input id="int" type="number" placeholder="18" />
          </div>
          <div class="field col-2">
            <label for="wis">WIS</label>
            <input id="wis" type="number" placeholder="15" />
          </div>
          <div class="field col-2">
            <label for="cha">CHA</label>
            <input id="cha" type="number" placeholder="23" />
          </div>
        </div>
        <div class="toolbar-row">
          <div class="section-header">Proficiencies & Senses</div>
          <div class="field col-6">
            <label for="saves">Saving Throws</label>
            <input id="saves" type="text" />
          </div>
          <div class="field col-6">
            <label for="skills">Skills</label>
            <input id="skills" type="text" />
          </div>
          <div class="field col-6">
            <label for="resist">Damage Resistances</label>
            <input id="resist" type="text" />
          </div>
          <div class="field col-6">
            <label for="immune">Damage Immunities</label>
            <input id="immune" type="text" />
          </div>
          <div class="field col-6">
            <label for="cond_imm">Condition Immunities</label>
            <input id="cond_imm" type="text" />
          </div>
          <div class="field col-6">
            <label for="senses">Senses</label>
            <input id="senses" type="text" />
          </div>
          <div class="field col-6">
            <label for="languages">Languages</label>
            <input id="languages" type="text" />
          </div>
        </div>
        <div class="toolbar-row">
          <div class="section-header">
            Abilities & Actions
            <span class="footer-note" style="margin-left: 8px"
              >Use [link text](URL) to create links.</span
            >
          </div>
          <div class="field col-12">
            <label>Spellcasting</label>
            <div id="spellcasting-list" class="dynamic-list"></div>
            <button
              type="button"
              class="btn btn-small"
              data-type="spellcasting"
            >
              Add Spell
            </button>
          </div>
          <div class="field col-12">
            <label>Traits</label>
            <div id="traits-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="traits">
              Add Trait
            </button>
          </div>
          <div class="field col-12">
            <label>Actions</label>
            <div id="actions-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="actions">
              Add Action
            </button>
          </div>
          <div class="field col-12">
            <label>Reactions</label>
            <div id="reactions-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="reactions">
              Add Reaction
            </button>
          </div>
          <div class="field col-12">
            <label>Legendary Actions</label>
            <div id="legendary-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="legendary">
              Add Legendary Action
            </button>
          </div>
          <div class="field col-12">
            <label>Mythic Actions</label>
            <div id="mythic-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="mythic">
              Add Mythic Action
            </button>
          </div>
          <div class="field col-12">
            <label>Lair Actions</label>
            <div id="lair-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="lair">
              Add Lair Action
            </button>
          </div>
          <div class="field col-12">
            <label>Regional Effects</label>
            <div id="regional-list" class="dynamic-list"></div>
            <button type="button" class="btn btn-small" data-type="regional">
              Add Regional Effect
            </button>
          </div>
        </div>
        <div class="toolbar-row">
          <div class="section-header">Notes & Inventory</div>
          <div class="field col-12">
            <label for="inventory">Inventory</label>
            <textarea id="inventory"></textarea>
          </div>
          <div class="field col-12">
            <label for="desc">Description / DM Notes</label>
            <textarea
              id="desc"
              placeholder="Tactics, lair notes, flavor, etc."
            ></textarea>
          </div>
          <div class="field col-12">
            <label for="source">Source</label>
            <input id="source" type="text" placeholder="MM p. 98" />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btn-apply">Apply Changes</button>
          <button class="btn" id="btn-update-url">Update URL</button>
          <button class="btn" id="btn-print">Print</button>
          <button class="btn" id="btn-copy-view">Copy View-Only Link</button>
          <button class="btn" id="btn-copy-embed">Copy Embed Link</button>
          <button class="btn" id="btn-clear">Clear</button>
        </div>
      </div>
      <div class="statblock" id="statblock">
        <div class="sb-header">
          <div class="sb-name" id="sb-name">Creature Name</div>
          <div class="sb-subtitle small" id="sb-subtitle">
            Size type, alignment
          </div>
          <div
            class="sb-subtitle small"
            id="sb-nickname-row"
            style="display: none"
          >
            (<span id="sb-nickname"></span>)
          </div>
        </div>
        <div class="sb-body">
          <div
            class="sb-row small"
            id="sb-inventory-row"
            style="display: none"
          >
            <span class="sb-label">Inventory</span>
            <span id="sb-inventory"></span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Armor Class</span>
            <span id="sb-ac">—</span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Hit Points</span>
            <span id="sb-hp">—</span>
          </div>
          <div class="sb-row small" id="sb-hit-dice-row" style="display: none">
            <span class="sb-label">Hit Dice</span>
            <span id="sb-hit-dice"></span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Speed</span>
            <span id="sb-speed">—</span>
          </div>
          <div class="hr"></div>
          <div class="abilities">
            <div class="ability">
              <div class="abbr">STR</div>
              <div class="score" id="sb-str">10</div>
              <div class="mod" id="sb-str-mod">(+0)</div>
            </div>
            <div class="ability">
              <div class="abbr">DEX</div>
              <div class="score" id="sb-dex">10</div>
              <div class="mod" id="sb-dex-mod">(+0)</div>
            </div>
            <div class="ability">
              <div class="abbr">CON</div>
              <div class="score" id="sb-con">10</div>
              <div class="mod" id="sb-con-mod">(+0)</div>
            </div>
            <div class="ability">
              <div class="abbr">INT</div>
              <div class="score" id="sb-int">10</div>
              <div class="mod" id="sb-int-mod">(+0)</div>
            </div>
            <div class="ability">
              <div class="abbr">WIS</div>
              <div class="score" id="sb-wis">10</div>
              <div class="mod" id="sb-wis-mod">(+0)</div>
            </div>
            <div class="ability">
              <div class="abbr">CHA</div>
              <div class="score" id="sb-cha">10</div>
              <div class="mod" id="sb-cha-mod">(+0)</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="sb-row small" id="sb-saves-row" style="display: none">
            <span class="sb-label">Saving Throws</span>
            <span id="sb-saves"></span>
          </div>
          <div class="sb-row small" id="sb-skills-row" style="display: none">
            <span class="sb-label">Skills</span>
            <span id="sb-skills"></span>
          </div>
          <div class="sb-row small" id="sb-resist-row" style="display: none">
            <span class="sb-label">Damage Resistances</span>
            <span id="sb-resist"></span>
          </div>
          <div class="sb-row small" id="sb-immune-row" style="display: none">
            <span class="sb-label">Damage Immunities</span>
            <span id="sb-immune"></span>
          </div>
          <div
            class="sb-row small"
            id="sb-cond-imm-row"
            style="display: none"
          >
            <span class="sb-label">Condition Immunities</span>
            <span id="sb-cond-imm"></span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Senses</span>
            <span id="sb-senses">—</span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Languages</span>
            <span id="sb-languages">—</span>
          </div>
          <div class="sb-row small" id="sb-prof-row" style="display: none">
            <span class="sb-label">Proficiency Bonus</span>
            <span id="sb-prof"></span>
          </div>
          <div class="sb-row small">
            <span class="sb-label">Challenge</span>
            <span id="sb-cr">—</span>
          </div>
          <div class="hr"></div>
          <div
            class="section"
            id="sb-spellcasting-section"
            style="display: none"
          >
            <div class="entry-list" id="sb-spellcasting"></div>
          </div>
          <div class="section" id="sb-traits-section" style="display: none">
            <div class="entry-list" id="sb-traits"></div>
          </div>
          <div class="section" id="sb-actions-section">
            <div class="entry">
              <div class="name">Actions</div>
            </div>
            <div class="entry-list" id="sb-actions"></div>
          </div>
          <div
            class="section"
            id="sb-reactions-section"
            style="display: none"
          >
            <div class="entry">
              <div class="name">Reactions</div>
            </div>
            <div class="entry-list" id="sb-reactions"></div>
          </div>
          <div
            class="section"
            id="sb-legendary-section"
            style="display: none"
          >
            <div class="entry">
              <div class="name">Legendary Actions</div>
            </div>
            <div class="entry-list" id="sb-legendary"></div>
          </div>
          <div class="section" id="sb-mythic-section" style="display: none">
            <div class="entry">
              <div class="name">Mythic Actions</div>
            </div>
            <div class="entry-list" id="sb-mythic"></div>
          </div>
          <div class="section" id="sb-lair-section" style="display: none">
            <div class="entry">
              <div class="name">Lair Actions</div>
            </div>
            <div class="entry-list" id="sb-lair"></div>
          </div>
          <div class="section" id="sb-regional-section" style="display: none">
            <div class="entry">
              <div class="name">Regional Effects</div>
            </div>
            <div class="entry-list" id="sb-regional"></div>
          </div>
          <div class="section" id="sb-desc-section" style="display: none">
            <div class="entry">
              <div class="name">Description</div>
            </div>
            <div class="description" id="sb-desc"></div>
          </div>
          <div class="footer-note small" id="sb-source"></div>
        </div>
      </div>
      <div class="footer-note" id="tips">
        Tips:
        <ul>
          <li>
            Click "Update URL" to rewrite the address bar with your current
            data.
          </li>
          <li>
            Share the full URL. Everything is encoded in the query string.
          </li>
          <li>
            Add view=1 to hide the editor; add embed=1 for minimal embed.
          </li>
        </ul>
      </div>
    </div>
    <div class="modal-overlay hidden" id="dice-modal">
      <div class="modal-content">
        <h3>Dice Roll</h3>
        <div id="modal-result"></div>
        <div id="modal-breakdown"></div>
        <button class="btn" id="modal-close" style="margin-top: 16px">
          Close
        </button>
      </div>
    </div>
    <script>
      function toInt(val, fallback = 10) {
        const n = parseInt(val, 10);
        return Number.isFinite(n) ? n : fallback;
      }
      function mod(score) {
        return Math.floor((score - 10) / 2);
      }
      function fmtMod(m) {
        return (m >= 0 ? "+" : "") + m;
      }
      function safeParseArray(input) {
        if (!input) return [];
        try {
          const parsed = JSON.parse(input);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }
      function setDisplay(el, show) {
        if (!el) return;
        el.classList.toggle("hidden", !show);
        el.style.display = show ? "" : "none";
      }
      function hasVal(v) {
        return String(v ?? "").trim().length > 0;
      }
      function field(id) {
        return document.getElementById(id);
      }
      function text(id, val) {
        const el = field(id);
        if (!el) return;
        el.textContent = hasVal(val) ? String(val) : "—";
      }
      function html(id, val) {
        const el = field(id);
        if (!el) return;
        el.innerHTML = hasVal(val) ? parseLinks(String(val)) : "—";
      }
      function joinClean(arr) {
        return arr
          .map((s) => String(s || "").trim())
          .filter(Boolean)
          .join(", ");
      }
      function parseLinks(str) {
        if (!str) return "";
        str = str.replace(
          /\[([^\]]+)\]\(([^)]+)\)/g,
          '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
        );
        str = str.replace(
          /(\(?\d+d\d+(\s*[+-]\s*\d+)?\)?)|\d+d\d+/g,
          (match) => {
            const dice = match.replace(/[()]/g, "");
            return `<span class="dice-roll" data-dice="${dice}">${match}</span>`;
          }
        );
        return str;
      }
      const DEBUG =
        new URLSearchParams(window.location.search).get("debug") === "1";
      function debug(...args) {
        if (DEBUG) console.log(...args);
      }
      function assertPlaceholders() {
        if (!DEBUG) return;
        const ids = [
          "sb-name",
          "sb-subtitle",
          "sb-nickname",
          "sb-inventory",
          "sb-ac",
          "sb-hp",
          "sb-hit-dice",
          "sb-speed",
          "sb-str",
          "sb-dex",
          "sb-con",
          "sb-int",
          "sb-wis",
          "sb-cha",
          "sb-saves",
          "sb-skills",
          "sb-resist",
          "sb-immune",
          "sb-cond-imm",
          "sb-senses",
          "sb-languages",
          "sb-prof",
          "sb-cr",
          "sb-desc",
          "sb-source",
          "sb-spellcasting",
          "sb-traits",
          "sb-actions",
          "sb-reactions",
          "sb-legendary",
          "sb-mythic",
          "sb-lair",
          "sb-regional",
        ];
        const missing = ids.filter((id) => !field(id));
        if (missing.length) {
          console.warn("Missing statblock placeholders:", missing);
        } else {
          debug("All statblock placeholders present.");
        }
      }
      function rollDice(diceString) {
        diceString = diceString.replace(/\s/g, "");
        const match = diceString.match(/(\d+)d(\d+)([+-]\d+)?/);
        if (!match) return { total: 0, rolls: [], modifier: 0 };
        const numDice = parseInt(match[1], 10);
        const numSides = parseInt(match[2], 10);
        const modifier = match[3] ? parseInt(match[3], 10) : 0;
        let total = 0;
        const rolls = [];
        for (let i = 0; i < numDice; i++) {
          const roll = Math.floor(Math.random() * numSides) + 1;
          rolls.push(roll);
          total += roll;
        }
        total += modifier;
        return { total, rolls, modifier };
      }
      function showDiceModal(diceString) {
        const modalResult = field("modal-result");
        const modalBreakdown = field("modal-breakdown");
        modalResult.textContent = "...";
        modalBreakdown.textContent = "rolling...";
        modalResult.classList.add("rolling");
        setDisplay(field("dice-modal"), true);
        setTimeout(() => {
          const result = rollDice(diceString);
          modalResult.textContent = result.total;
          let breakdown = `(${result.rolls.join(" + ")})${
            result.modifier
              ? (result.modifier > 0 ? " + " : " - ") +
                Math.abs(result.modifier)
              : ""
          }`;
          modalBreakdown.textContent = breakdown;
          modalResult.classList.remove("rolling");
        }, 500);
      }
      function createDynamicEntry(item = { name: "", text: "" }) {
        const entryDiv = document.createElement("div");
        entryDiv.className = "dynamic-entry";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "entry-name";
        nameInput.placeholder = "Name";
        nameInput.value = item.name || "";
        const textInput = document.createElement("textarea");
        textInput.className = "entry-text";
        textInput.placeholder = "Description";
        textInput.value = item.text || "";
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn btn-small";
        removeBtn.textContent = "Remove";
        removeBtn.onclick = () => entryDiv.remove();
        entryDiv.appendChild(nameInput);
        entryDiv.appendChild(textInput);
        entryDiv.appendChild(removeBtn);
        return entryDiv;
      }
      function addDynamicEntry(type) {
        const list = field(`${type}-list`);
        if (list) {
          list.appendChild(createDynamicEntry());
        }
      }
      function pullDynamicListData(type) {
        const list = field(`${type}-list`);
        if (!list) return "[]";
        const items = [];
        list.querySelectorAll(".dynamic-entry").forEach((entry) => {
          const name = entry.querySelector(".entry-name").value.trim();
          const text = entry.querySelector(".entry-text").value.trim();
          if (name || text) {
            items.push({ name, text });
          }
        });
        return JSON.stringify(items);
      }
      function pushDynamicListData(type, data) {
        const list = field(`${type}-list`);
        if (!list) return;
        list.innerHTML = "";
        const items = safeParseArray(data);
        items.forEach((item) => {
          list.appendChild(createDynamicEntry(item));
        });
      }
      function renderEntries(containerId, list) {
        const el = field(containerId);
        if (!el) return;
        el.innerHTML = "";
        list.forEach((it) => {
          const wrap = document.createElement("div");
          wrap.className = "entry small";
          if (it.name) {
            const nm = document.createElement("div");
            nm.className = "name";
            nm.innerHTML = `<em><strong>${it.name}.</strong></em>`;
            wrap.appendChild(nm);
          }
          if (it.text) {
            const tx = document.createElement("div");
            tx.className = "text";
            tx.innerHTML = parseLinks(it.text || "");
            wrap.appendChild(tx);
          }
          el.appendChild(wrap);
        });
      }
      function moveInventoryAndProfWithCR() {
        const invRow = field("sb-inventory-row");
        const profRow = field("sb-prof-row");
        const crRow = field("sb-cr")?.closest(".sb-row");
        if (crRow) {
          if (profRow) crRow.insertAdjacentElement("afterend", profRow);
          if (invRow) crRow.insertAdjacentElement("afterend", invRow);
        }
      }
      function applyToStatblock(data) {
        debug("Applying data to statblock:", data);
        text("sb-name", data.name);
        const subtitle = joinClean([data.size, data.type, data.alignment]);
        text("sb-subtitle", subtitle);
        setDisplay(field("sb-nickname-row"), hasVal(data.nickname));
        text("sb-nickname", data.nickname);
        setDisplay(field("sb-inventory-row"), hasVal(data.inventory));
        html("sb-inventory", data.inventory);
        text("sb-ac", data.ac);
        html("sb-hp", data.hp);
        setDisplay(field("sb-hit-dice-row"), hasVal(data.hit_dice));
        html("sb-hit-dice", data.hit_dice);
        text("sb-speed", data.speed);
        ["str", "dex", "con", "int", "wis", "cha"].forEach((k) => {
          const score = toInt(data[k], 10);
          const m = mod(score);
          text("sb-" + k, score);
          text("sb-" + k + "-mod", "(" + fmtMod(m) + ")");
        });
        setDisplay(field("sb-saves-row"), hasVal(data.saves));
        text("sb-saves", data.saves);
        setDisplay(field("sb-skills-row"), hasVal(data.skills));
        text("sb-skills", data.skills);
        setDisplay(field("sb-resist-row"), hasVal(data.resist));
        text("sb-resist", data.resist);
        setDisplay(field("sb-immune-row"), hasVal(data.immune));
        text("sb-immune", data.immune);
        setDisplay(field("sb-cond-imm-row"), hasVal(data.cond_imm));
        text("sb-cond-imm", data.cond_imm);
        text("sb-senses", data.senses);
        text("sb-languages", data.languages);
        setDisplay(field("sb-prof-row"), hasVal(data.prof));
        text("sb-prof", data.prof);
        text(
          "sb-cr",
          joinClean([data.cr, data.lair_cr ? `(Lair: ${data.lair_cr})` : ""])
        );
        const dynamicSections = [
          "spellcasting",
          "traits",
          "actions",
          "reactions",
          "legendary",
          "mythic",
          "lair",
          "regional",
        ];
        dynamicSections.forEach((type) => {
          const items = safeParseArray(data[type]);
          const sectionEl = field(`sb-${type}-section`);
          const hasContent = items.length > 0;
          setDisplay(sectionEl, hasContent);
          if (hasContent) renderEntries(`sb-${type}`, items);
          debug(`section ${type}:`, items);
        });
        setDisplay(field("sb-desc-section"), hasVal(data.desc));
        html("sb-desc", data.desc);
        text("sb-source", data.source);
        moveInventoryAndProfWithCR();
      }
      function pullFromForm() {
        const data = {
          name: field("name").value,
          nickname: field("nickname").value,
          size: field("size").value,
          type: field("type").value,
          alignment: field("alignment").value,
          ac: field("ac").value,
          hp: field("hp").value,
          hit_dice: field("hit_dice").value,
          speed: field("speed").value,
          str: field("str").value,
          dex: field("dex").value,
          con: field("con").value,
          int: field("int").value,
          wis: field("wis").value,
          cha: field("cha").value,
          prof: field("prof").value,
          saves: field("saves").value,
          skills: field("skills").value,
          resist: field("resist").value,
          immune: field("immune").value,
          cond_imm: field("cond_imm").value,
          senses: field("senses").value,
          languages: field("languages").value,
          cr: field("cr").value,
          lair_cr: field("lair_cr").value,
          inventory: field("inventory").value,
          desc: field("desc").value,
          source: field("source").value,
        };
        const dynamicSections = [
          "spellcasting",
          "traits",
          "actions",
          "reactions",
          "legendary",
          "mythic",
          "lair",
          "regional",
        ];
        dynamicSections.forEach((type) => {
          data[type] = pullDynamicListData(type);
        });
        return data;
      }
      function pushToForm(d) {
        const fields = [
          "name",
          "nickname",
          "size",
          "type",
          "alignment",
          "ac",
          "hp",
          "hit_dice",
          "speed",
          "str",
          "dex",
          "con",
          "int",
          "wis",
          "cha",
          "prof",
          "saves",
          "skills",
          "resist",
          "immune",
          "cond_imm",
          "senses",
          "languages",
          "cr",
          "lair_cr",
          "inventory",
          "desc",
          "source",
        ];
        fields.forEach((f) => {
          if (field(f)) field(f).value = d[f] || "";
        });
        const dynamicSections = [
          "spellcasting",
          "traits",
          "actions",
          "reactions",
          "legendary",
          "mythic",
          "lair",
          "regional",
        ];
        dynamicSections.forEach((type) => {
          pushDynamicListData(type, d[type]);
        });
      }
      function encodeParams(data) {
        const params = new URLSearchParams();
        Object.entries(data).forEach(([k, v]) => {
          if (v != null && String(v).trim() !== "" && String(v).trim() !== "[]") {
            params.set(k, v);
          }
        });
        return params;
      }
      function decodeParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const data = {};
        urlParams.forEach((value, key) => {
          data[key] = value;
        });
        return data;
      }
      function updateUrl(data, extra = {}) {
        const params = encodeParams({ ...data, ...extra });
        const newUrl =
          window.location.pathname +
          (params.toString() ? "?" + params.toString() : "");
        window.history.replaceState({}, "", newUrl);
      }
      function clearAll() {
        const inputs = document.querySelectorAll(
          "input[type='text'], input[type='number'], textarea"
        );
        inputs.forEach((i) => (i.value = ""));
        const dynamicLists = document.querySelectorAll(".dynamic-list");
        dynamicLists.forEach((list) => (list.innerHTML = ""));
        applyToStatblock({});
        updateUrl({});
      }
      function copyLinkWithFlag(flag, val) {
        const d = pullFromForm();
        const params = encodeParams(d);
        if (val == null) {
          params.delete(flag);
        } else {
          params.set(flag, String(val));
        }
        const url =
          window.location.origin +
          window.location.pathname +
          (params.toString() ? "?" + params.toString() : "");
        navigator.clipboard
          .writeText(url)
          .then(() => alert("Link copied to clipboard"))
          .catch(() =>
            alert("Copy failed. You can copy from the address bar.")
          );
      }
      function setTheme(theme) {
        document.documentElement.classList.toggle(
          "dark-mode",
          theme === "dark"
        );
        localStorage.setItem("theme", theme);
      }
      function applyViewModes() {
        const data = decodeParams();
        const isEmbed = data.embed === "1" || data.embed === "true";
        const isView = data.view === "1" || data.view === "true";
        if (isEmbed) {
          document.body.classList.add("embed-root");
          setDisplay(field("toolbar"), false);
          setDisplay(field("tips"), false);
          setDisplay(field("theme-toggle"), false);
          const darkModeMatcher = window.matchMedia(
            "(prefers-color-scheme: dark)"
          );
          function handleThemeChange(e) {
            setTheme(e.matches ? "dark" : "light");
          }
          darkModeMatcher.addListener(handleThemeChange);
          handleThemeChange(darkModeMatcher);
        } else if (isView) {
          setDisplay(field("toolbar"), false);
          setDisplay(field("tips"), false);
          setDisplay(field("theme-toggle"), false);
        } else {
          setDisplay(field("toolbar"), true);
          setDisplay(field("tips"), true);
          setDisplay(field("theme-toggle"), true);
        }
      }
      window.addEventListener("DOMContentLoaded", () => {
        assertPlaceholders();
        const DEMO =
          new URLSearchParams(window.location.search).get("demo") === "1";
        const data = DEMO ? {} : decodeParams();
        const preloadIfEmpty = Object.keys(data).length === 0;
        if (preloadIfEmpty || DEMO) {
          const example = DEMO
            ? {
                name: "Test Creature",
                nickname: "The Tester",
                size: "Medium",
                type: "humanoid",
                alignment: "neutral",
                ac: "15 (studded leather)",
                hp: "100 (10d10+50)",
                hit_dice: "10d10+50",
                speed: "30 ft., fly 60 ft.",
                str: "18",
                dex: "14",
                con: "20",
                int: "12",
                wis: "16",
                cha: "10",
                prof: "+3",
                saves: "Str +7, Dex +5",
                skills: "Perception +6, Stealth +5",
                resist: "cold",
                immune: "fire",
                cond_imm: "frightened",
                senses: "darkvision 60 ft., passive Perception 16",
                languages: "Common, Draconic",
                cr: "5 (1,800 XP)",
                lair_cr: "6",
                inventory: "Sword, Shield, [Potion](https://example.com) (2d4+2)",
                desc: "This is a test description.",
                source: "Custom Source",
                traits: JSON.stringify([
                  { name: "Trait A", text: "Trait description A." },
                  { name: "Trait B", text: "Trait description B." },
                ]),
                actions: JSON.stringify([
                  { name: "Action A", text: "Action description A." },
                ]),
                reactions: JSON.stringify([
                  { name: "Reaction A", text: "Reaction description A." },
                ]),
                legendary: JSON.stringify([
                  { name: "Legendary A", text: "Legendary description A." },
                ]),
                mythic: JSON.stringify([
                  { name: "Mythic A", text: "Mythic description A." },
                ]),
                lair: JSON.stringify([
                  { name: "Lair A", text: "Lair description A." },
                ]),
                regional: JSON.stringify([
                  { name: "Regional A", text: "Regional description A." },
                ]),
              }
            : {
                name: "Adult Red Dragon",
                nickname: "Ashardalon",
                size: "Huge",
                type: "dragon",
                alignment: "chaotic evil",
                ac: "19 (natural armor)",
                hp: "256 (19d12 + 133)",
                hit_dice: "19d12+133",
                speed: "40 ft., climb 40 ft., fly 80 ft.",
                str: "27",
                dex: "10",
                con: "25",
                int: "16",
                wis: "13",
                cha: "21",
                prof: "+6",
                saves: "Dex +6, Con +13, Wis +7, Cha +10",
                skills: "Perception +13, Stealth +6",
                immune: "fire",
                senses:
                  "blindsight 60 ft., darkvision 120 ft., passive Perception 23",
                languages: "Common, Draconic",
                cr: "17 (18,000 XP)",
                inventory: "Hoard of gold, [Magic Sword](https://example.com)",
                traits:
                  '[{"name":"Legendary Resistance (3/Day)","text":"If the dragon fails a saving throw, it can choose to succeed instead."}]',
                actions:
                  '[{"name":"Multiattack","text":"The dragon can use its Frightful Presence. It then makes three attacks: one with its bite and two with its claws."}, {"name":"Bite","text":"+14 to hit, reach 10 ft., one target. Hit: 19 (2d10 + 8) piercing damage plus 7 (2d6) fire damage."}]',
                legendary:
                  '[{"name":"Detect","text":"The dragon makes a Wisdom (Perception) check."}, {"name":"Wing Attack (Costs 2 Actions)","text":"The dragon beats its wings. Each creature within 10 feet must succeed on a DC 22 Dexterity saving throw or take 13 (2d6 + 6) bludgeoning damage and be knocked prone."}]',
                desc: "A proud and terrible tyrant of the skies.",
                source: "Monster Manual, p. 98",
              };
          pushToForm(example);
          applyToStatblock(example);
          updateUrl(example);
        } else {
          pushToForm(data);
          applyToStatblock(data);
        }
        applyViewModes();
        const savedTheme = localStorage.getItem("theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme) {
          setTheme(savedTheme);
        } else {
          setTheme(systemPrefersDark ? "dark" : "light");
        }
        field("btn-apply").addEventListener("click", () =>
          applyToStatblock(pullFromForm())
        );
        field("btn-update-url").addEventListener("click", () =>
          updateUrl(pullFromForm())
        );
        field("btn-clear").addEventListener("click", clearAll);
        field("btn-print").addEventListener("click", () => window.print());
        field("btn-copy-view").addEventListener("click", () =>
          copyLinkWithFlag("view", 1)
        );
        field("btn-copy-embed").addEventListener("click", () =>
          copyLinkWithFlag("embed", 1)
        );
        field("theme-toggle").addEventListener("click", () => {
          const currentTheme = document.documentElement.classList.contains(
            "dark-mode"
          )
            ? "dark"
            : "light";
          setTheme(currentTheme === "dark" ? "light" : "dark");
        });
        document.querySelectorAll("button[data-type]").forEach((btn) => {
          btn.addEventListener("click", () => addDynamicEntry(btn.dataset.type));
        });
        field("modal-close").addEventListener("click", () =>
          setDisplay(field("dice-modal"), false)
        );
        field("dice-modal").addEventListener("click", (e) => {
          if (e.target === field("dice-modal")) {
            setDisplay(field("dice-modal"), false);
          }
        });
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("dice-roll")) {
            showDiceModal(e.target.dataset.dice);
          }
        });
      });
    </script>
  </body>
</html>